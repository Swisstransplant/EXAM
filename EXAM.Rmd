---
title: "EXAM: Ex-vivo allograft monitoring"
author: "Swisstransplant"
date: "v1.0"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: swt_dashboard.css
runtime: shiny
resource_files:
- SWT_negativ_2021.png
---

```{r setup, include=FALSE}
library(fs) # MIT
library(flexdashboard) # MIT
library(shiny) # GPL-3
library(swt) # GPL-3
#library(data.table)
library(plotly) # MIT
```

```{r data}
data("exam-examples")
data.organ = exam.organ
data.device = exam.device
data.sumstats = exam.sumstats
data.timeseries = exam.timeseries
N = nrow(data.device) - 2 # subtract Testdata
newest.case = substr(sort(data.device$StartTime)[1], 1, 10)
oldest.case = substr(sort(data.device$StartTime, decreasing = TRUE)[1], 1, 10)

col = swt_colors()
```

```{r}
myFile = NA
tmp <- eventReactive(input$file1,{
  #dataset <- read.csv(input$file1$datapath)
  
  
  tmp = read_lifeport(file = input$file1$datapath, format = "guess")
  
  # process lifeport data
  tmp = process_lifeport(lpdat = tmp, window_size = 15)
  
  # summary stats
  tmp = sumstats_lifeport(lpdat = tmp, ice_threshold = 2.5)
})
```


Column {.sidebar data-width=200}
-----------------------------------------------------------------------

![](SWT_negativ_2021.png){width=85%}

```{r}
selectInput(inputId = "ID", label = "Select Donor ID:",
            choices = sort(data.organ$ID, decreasing = TRUE))

fileInput("file1", "Choose CSV File",
          multiple = FALSE,
          accept = c("text/csv",
                     "text/comma-separated-values,text/plain",
                     ".csv"))
```

Filename: `r data.organ$ID`

```{r}
hline <- function(y = 0, color = "grey", type="dash") {
  list(
    type = "line", 
    x0 = 0, 
    x1 = 1, 
    xref = "paper",
    y0 = y, 
    y1 = y, 
    line = list(color = color, dash=type)
  )
}

vline <- function(x = 0, color = "grey", type="dash") {
  list(
    type = "line",
    y0 = 0,
    y1 = 1,
    yref = "paper",
    x0 = x,
    x1 = x,
    line = list(color = color, dash=type)
  )
}
```


Row {data-width=800, data-height=130}
-----------------------------------------------------------------------
### Organ and Device Information

```{r}
renderTable({
  i = which(data.organ$ID == input$ID)
  tab = cbind(data.organ[i, "ID"],
              data.device[i, c("SerialNumber", "UnitID", "StartTime", 
                               "StopTime", "Runtime")],
              data.sumstats[i, "perfusion.dur.str"]
  )
  colnames(tab) = c("Donor ID", "Serial no.", "Unit ID", 
                    "Start time", "Stop time", "Run time", "Perfusion time")
  #colnames(tab)[grep("CrossClampTime.Date", colnames(tab))] = "CrossClamp"
  
  tab
})
```


Row {data-width=400, data-height=300}
-----------------------------------------------------------------------

### Pressure Chart

```{r}
renderPlotly({
  i = which(data.organ$ID == input$ID)
  d = data.timeseries[[i]]
  d.long = data.frame(pressure = c(d$SystolicPressure.flt, d$DiastolicPressure.flt),
                      time.clock = c(d$time.clock, d$time.clock),
                      group = c(rep("systolic pressure", nrow(d)), 
                                rep("diastolic pressure", nrow(d))))
  d.long$group = factor(d.long$group, levels = c("systolic pressure", "diastolic pressure"))
  figD = plot_ly(d.long, x=~time.clock, y=~pressure, type="scatter", mode="lines", 
                 color=~group, colors = c(col$blue.swt, col$darkyellow.kidney))
  figD = figD %>% layout(yaxis = list(title = "mmHg", range = c(0,45)),
                         xaxis = list(title = "Time"),
                         legend = list(orientation = 'h',  yanchor="bottom",  
                                       y=1.02, x =1, xanchor="right"),
                         shapes = list(hline(30))
  )
  
})
```

### Flow Rate Chart

```{r}
renderPlotly({
  i = which(data.organ$ID == input$ID)
  d = data.timeseries[[i]]
  
  # handle timeseries shorter than 30 min.
  if(length(d$time.clock) >= 181) {
    tgreyend =  d$time.clock[181]
  } else {
    tgreyend = d$time.clock[length(d$time.clock)]
  }
  
  figC = plot_ly(d, x=~time.clock, y=~FlowRate.flt, type="scatter", mode="lines",
                 color="all", colors = col$blue.swt)
  figC= figC %>% layout(yaxis = list(title = "ml/min", range = c(0,200)),
                        xaxis = list(title = "Time"),
                        shapes = list(hline(85), 
                                      list(type = "rect", fillcolor = "grey",
                                           line = list(color = "grey"), opacity = 0.3,
                                           x0 = d$time.clock[1], x1 = tgreyend, xref = "x",
                                           y0 = 0, y1 = 200, yref = "y")
                        )
  )
})
```

Row {data-width=400, data-height=130}
-----------------------------------------------------------------------
### Summary Statistics
```{r}
renderTable({
  i = which(data.organ$ID == input$ID)
  tab = data.sumstats[i, c("systolicPressure.md", "diastolicPressure.mean")] 
  colnames(tab) = c("<i>md</i><sub>sys</sub>", "<i>m</i><sub>dia</sub>")
  tab
}, sanitize.text.function = function(x) x)
```

### Summary Statistics
```{r}
renderTable({
  i = which(data.organ$ID == input$ID)
  tab = data.sumstats[i, c("flowRate.mean")]
  colnames(tab) = c("<i>m</i><sub>flow</sub>")
  tab
}, sanitize.text.function = function(x) x)
```

Row {data-width=400, data-height=300}
-----------------------------------------------------------------------

### Vascular Resistance Chart

```{r}
renderPlotly({
  i = which(data.organ$ID == input$ID)
  d = data.timeseries[[i]]
  
  # handle timeseries shorter than 30 min.
  if(length(d$time.clock) >= 181) {
    tgreyend =  d$time.clock[181]
  } else {
    tgreyend = d$time.clock[length(d$time.clock)]
  }
  
  figB = plot_ly(d, x=~time.clock, y=~OrganResistance.flt, type="scatter", mode="lines",
                 color="all", colors = col$blue.swt)
  figB= figB %>% layout(yaxis = list(title = "mmHg/ml/min", range = c(0,0.5)),
                        xaxis = list(title = "Time"),
                        shapes = list(hline(0.1), 
                                      hline(0.30),
                                      list(type = "rect", fillcolor = "grey",
                                           line = list(color = "grey"), opacity = 0.3,
                                           x0 = d$time.clock[1], x1 = tgreyend, xref = "x",
                                           y0 = 0, y1 = 0.5, yref = "y")
                        )
  )
})
```

### Temperature Chart

```{r}
renderPlotly({
  i = which(data.organ$ID == input$ID)
  d = data.timeseries[[i]]
  d.long = data.frame(temperature = c(d$IceContainerTemperature, d$InfuseTemperature),
                      time.clock = c(d$time.clock, d$time.clock),
                      group = c(rep("ice temperature", nrow(d)), 
                                rep("perfusate temperature", nrow(d))))
  d.long$group = factor(d.long$group, levels = c("ice temperature", "perfusate temperature"))
  # shapes with high temperature segments
  myshapes = list(hline(5), hline(10))
  ishigh = d$InfuseTemperature > 10 & d$FlowRate.flt > 5 & !is.na(d$FlowRate.flt)
  
  if (sum(ishigh, na.rm = TRUE) > 0) { # if there are segments
    onOff = diff(ishigh) # on 1, off -1
    if(ishigh[1]) {onOff[1] = 1}
    if(ishigh[length(ishigh)]) {onOff[length(onOff)] = -1}
    
    idx_on = which(onOff == 1)
    idx_off = which(onOff == -1)
    
    for (i in 1:length(idx_on)) {
      myshapes[[i+2]] = list(type = "rect", fillcolor = col$strongred.akzent,
                             line = list(color = "grey", width=0), opacity = 0.25,
                             x0 = d$time.clock[idx_on[i]], x1 = d$time.clock[idx_off[i]], xref = "x",
                             y0 = 0, y1 = 20, yref = "y")
    }
  }
  
  figA = plot_ly(d.long, x=~time.clock, y=~temperature, type="scatter", mode="lines",
                 color=~group, colors = c(col$blue.swt, col$darkyellow.kidney))
  figA = figA %>% layout(yaxis = list(title = "Degrees Celsius", range = c(0,15)),
                         xaxis = list(title = "Time"),
                         legend = list(orientation = 'h',  yanchor="bottom",  
                                       y=1.02, x =1, xanchor="right"),
                         shapes = myshapes
  )
  
})
```

Row {data-width=400, data-height=130}
-----------------------------------------------------------------------

### Summary Statistics
```{r}
renderTable({
  i = which(data.organ$ID == input$ID)
  tab = data.sumstats[i, c("organResistance.mean")]
  colnames(tab) = c("<i>m</i><sub>res</sub>")
  tab
}, sanitize.text.function = function(x) x)
```

### Summary Statistics
```{r}
renderTable({
  i = which(data.organ$ID == input$ID)
  tab = data.sumstats[i,c("iceContainerTemperature.mean","iceContainerTemperature.sd",
                          "iceContainerTemperature.minAbove.str", "infuseTemperature.start",
                          "infuseTemperature.mean", "infuseTemperature.sd",
                          "infuseTemperature.minAbove.str")]
  colnames(tab) = c("<i>m</i><sub>ice</sub>", "<i>SD</i><sub>ice</sub>", 
                    "<i>&#916t</i><sub>y > 2.5</sub>", "<i>y</i><sub>start</sub>",
                    "<i>m</i><sub>perf</sub>", "<i>SD</i><sub>perf</sub>", 
                    "<i>&#916t</i><sub>y > 10</sub>")
  tab
}, sanitize.text.function = function(x) x)
```

Row {data-width=800, data-height=130}
-----------------------------------------------------------------------
### Quality control

```{r}
renderTable({
  i = which(data.organ$ID == input$ID)
  tab = cbind(
    data.organ[i, c("OrganID", "KidneySide")],
    data.sumstats[i, c("D2temp", "Ptemp")]
  )
  colnames(tab) = c("Organ ID entry", "Kidney side entry",
                    "<i>D</i><sup>2</sup><sub>temp</sub>",
                    "<i>P</i><sub>temp</sub>")
  
  tab
}, sanitize.text.function = function(x) x)
```